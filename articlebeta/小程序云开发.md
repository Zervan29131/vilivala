### 云开发 CMS 管理系统

云开发 CMS 内容管理系统是云开发提供的一个扩展程序，可以在云开发控制台一键安装在自己的云开发环境中，方便开发人员和内容运营者随时随地管理小程序 / Web 等多端云开发内容数据。不用编写代码就可以使用，还提供了 PC /移动端浏览器访问支持，支持文本、富文本、图片、文件、关联类型等多种类型的可视化编辑。

### 功能特性

| 特性         | 介绍                                                         |
| :----------- | :----------------------------------------------------------- |
| 免开发       | 基于后台建模配置生成内容管理界面，无须编写代码               |
| 多端适配     | 支持 PC/移动端访问和管理内容                                 |
| 功能丰富     | 支持文本、富文本、图片、文件 等多种类型内容的可视化编辑，并且支持内容关联 |
| 权限控制     | 系统基于管理员/运营者两种身份角色的访问控制                  |
| 外部系统集成 | 支持 Webhook 接口，可以用于在运营修改修改内容后通知外部系统，如自动构建静态网站、发送通知等 |
| 数据源兼容   | 支持管理小程序/ Web / 移动端的云开发数据，支持管理已有数据集合，也可以在 CMS 后台创建新的内容和数据集合 |
| 部署简单     | 可在云开发控制台扩展管理界面一键部署和升级                   |

### 场景

**适用于需要为小程序应用增加一个运营管理后台的业务**

小程序应用有偏运营方面的文章编辑和发布、运营活动配置、素材管理等数据管理需求，使用 CMS 扩展之后，不用手动线上修改 db 数据，也不用投入人力物力开发管理后台，可以随时随地使用自己环境下部署的 CMS 内容管理系统来管理，同时还支持区分管理员和运营者的身份权限。

**适用于快速开发内容型的网站应用、小程序应用等场景**

CMS 内容管理系统还可以帮助开发者提升开发网站应用、小程序应用的效率，省去一部分后端开发工作。例如安装了CMS 扩展之后，解决了内容和数据的管理和生产问题，直接可以结合前端应用框架读取 db 数据进行渲染。

### 使用 CMS 

#### 访问 CMS 系统

CMS 扩展已经部署在当前环境下的静态网站托管中，访问路径为“静态托管的默认域名+安装设置的部署路径”

访问地址的格式如下：

```
云开发静态托管默认域名/部署路径`，例如 `https://xxxx.tcloudbaseapp.com/tcb-cms/
```

打开 CMS 系统后首先会提示需要登录，我们首先使用使用安装扩展时设置的管理员账号和密码进行登录

#### 管理内容

登录成功后，首先需要进行内容的建模设置，例如我们想为自己的博客应用（小程序/网站）来生成管理界面。

假设当前已有一个管理 文章的数据库集合 `articles`，我们可以在 CMS 管理后台新建一个“文章”内容来生成“文章”类型的内容管理界面。

（如果新建内容的时候指定的集合名不存在，CMS 扩展会自动新建集合）



假设数据库集合 `articles` 的结构如下：

| 字段名     | 类型     | 描述                                         |
| :--------- | :------- | :------------------------------------------- |
| _id        | ID       | 文章唯一 id                                  |
| name       | String   | 文章标题                                     |
| cover      | String   | 封面图，这里存放云开发的存储的文件的 cloudID |
| content    | String   | 文章内容，采用 markdown 格式                 |
| author     | ID       | 作者的用户 id                                |
| createTime | DateTime | 创建时间                                     |
| updateTime | DateTime | 更新时间                                     |
| tag        | String[] | 标签，例如 `["serverless","cms"]`            |
| category   | String[] | 分类，例如 `["前端","开发"]`                 |

我们在“内容设置”中点击“新建”来创建“文章”类型时，可以对照上面的集合数据把字段类型和字段的限制进行配置，

例如封面图可以直接选择 “图片”字段类型，文章内容可以直接选择 “Markdown” 类型，

这样在生成的管理界面里可以直接上传图片和通过编辑器编写文章，

保存在数据库集合的时候，依然会保存为数据库支持的类型，图片会存储为云存储的 CloudID, 内容会存储为字符串等。

创建并保存之后会自动刷新生成”文章“的运营界面。



接下来就可以进行运营管理内容操作了，可以使用运营者身份登录，对新创建的“文章”进行操作，我们可以新建一篇文章。

文章发布成功后，即可在文章列表中看到这篇文章



采用 CMS 管理的内容，依然可以通过云开发各端 SDK 进行访问

（需要注意的是在前端访问时，需要正确设置数据库的安全规则设置，例如设置为所有用户可读，仅创建者可写）



例如，在上面的例子里，我们需要在云函数中获取文章的标签是 `CloudBase` 的最新 10 条文章，可以采用以下代码来获取数据：

```
db.collection("articles")
  .where({ tag: "CloudBase" })
  .orderBy("createTime", "desc")
  .limit(10)
  .get();
```

获取到内容数据就可以在各种场景使用了。

小程序端连接云数据库实现增删改查(基础的)，然后小程序端可以直接调用云数据库中的数据

1.小程序端一次增加一条或者多条记录

```js
wx.cloud.database().collection('test').add({
      data: {
        字段名1: 值1,字段名2: 值2 ... ...
      }
    }).then((res) => {
     console.log(res)//返回的res里面有_id的值，这个_id是系统自动生成的。
   }).catch(err=>{
     console.log(err)
   })

/***若想已经存在的记录增加字段，就要用到update了。*/
```

2.小程序端查找一条或者多条或是全部记录

```js
//一、获取某一条记录
wx.cloud.database().collection('test').doc('_id的值').get()
.then(res => {
        console.log(res)
      }).catch(err => {
        console.log(err)
      })
/*_id的值可以从云数据库中的集合中的记录中，复制自己想要的字段里面的_id的值。*/

//二、获取某个集合中的所有记录,但是小程序端中默认只能获取20条数据且最多是20条
  wx.cloud.database().collection('test').get()
      .then(res => {
        console.log(res)//返回的res里面有_id的值，这个_id是系统自动生成的。
      })
      .catch(err => {
        console.log(err)
      })

// 三、where查询，指定查询条件
//1.使用数据库集合查询
 wx.cloud.database().collection('test').where({
        字段名1:值1
 }).get().then(res=>{console.log(res)})

//返回的res里面有_id的值，这个_id是系统自动生成的。
/*值的类型需要与云数据库表中的记录中的相字段名的值一致，如都是Number类型。查询条件可以有多个，
用逗号隔开。*/

//2.使用数据库操作符查找
const db = wx.cloud.database()
const _ = db.command
db.collection('test').where({
        字段名: _.eq(value)
 }).get().then(res=>{console.log(res)})
/*筛选出集合中与value值相等的记录,数据类型也要一致*/

// 四、指定返回结果中记录需返回的字段
wx.cloud.database().collection('test').field(
{字段名1: true,字段名2:true,字段名3:false... ...}).get().then(res => {
        console.log(res.data)
      }).catch(err => {
        console.log(err)
      })
/**对象的各个字段名表示要返回或不要返回的字段，value 传入 true|false（或 1|-1）表示要
返回还是不要返回。但是没有该字段名但是值为true,不会报错只会输出'_id'的数组（自测得）。**/
```

3.小程序端删除一条记录

```js
wx.cloud.database().collection('test').doc('_id的值')
.remove().then((res) => {
       console.log(res.stats)
     }).catch(err=>{
       console.log(err)
     })
/*_id的值可以从云数据库中的集合中的记录中复制自己想要的字段里面的_id的值。*/
```

4.更新一条或者多条记录

```js
//1.update,不会删除原有的添加新字段
wx.cloud.database().collection('test').doc('_id的值').update({
   data:{
        字段名1: 值1,字段名2:值2,字段名3:值3... ...
        }
      }).then((res) => {
       console.log(res.stats)
     }).catch(err=>{
       console.log(err)
     })
/*_id的值可以从云数据库中的集合中的记录中复制自己想要的字段里面的_id的值。*/

//2.set，会删除原有的的字段，但不会删除系统自动生成的字段，
/*如果不想原有的某些字段被删就要set数据的时候带上*/
wx.cloud.database().collection('test').doc('_id的值').set({
   data:{
        字段名1: 值1,字段名2:值2,字段名3:值3... ...
        }
      }).then((res) => {
       console.log(res.stats)
     }).catch(err=>{
       console.log(err)
     })
/*_id的值可以从云数据库中的集合中的记录中复制自己想要的字段里面的_id的值。*/
```

5.分页显示后，过滤数据

```js
data: {
    list:[],
    num:2
  },
//1.onLoad中从云数据库中获取集合中的所有数据
  /**
   * 生命周期函数--监听页面加载
   */
onLoad: function (options) {
    // 小程序端默认只能获取20条数据且最多是20条
    wx.cloud.database().collection('test')
      .skip(0)
      .limit(20).get().then(res => {
        console.log('获取成功', res)
        this.setData({
          list: res.data
        })
      }).catch(res => {
        console.log('获取失败', res)
      })
},
//2.页面上拉加载时，
/**
   * 页面上拉触底事件的处理函数
   */
onReachBottom: function () {
    console.log('加载更多。。。')
    wx.cloud.database().collection('test')
      .skip((this.data.num - 1) * 20)
      .limit(20)
      .get().then(res => {
        console.log('获取成功', res)
        this.setData({
          // 拼接
          list: this.data.list.concat(res.data),
          num: this.data.num + 1
        })
      }).catch(res => {
        console.log('获取失败', res)
      })
},
//3.过滤数据
/*test.wxml中判断获取的数组中是否有某字段,如，wx:if="{{item.isAlreadyPay?ture:false}}"，
如果该字段存在在数据就显示否则就不显示,前提是已经用isAlreadyPay字段记下了用户的操作了。*/
```



## 在小程序中使用数据

获取商品数据的代码如下

```js
wx.cloud.init({
  env: "envId"
});

// 查询数据
const db = wx.cloud.database();
db.collection("goods")
  .where({})
  .get()
  .then((res) => {
    // 商品数据
    console.log(res.data);
  });
```

